name: Podcast Automation

on:
  # Run every Sunday at 9 AM UTC (adjust timezone as needed)
  schedule:
    - cron: '0 9 * * 0'

  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Number of days to look back (default: 7)'
        required: false
        default: '7'

jobs:
  process-podcasts:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run podcast automation
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OUTPUT_FOLDER: ./output/podcast_notes
        OBSIDIAN_FOLDER: ./output/summaries
      run: |
        echo "ðŸš€ Starting podcast automation..."
        python main.py
        echo "âœ… Automation completed!"

    - name: Upload generated files as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: podcast-summaries-${{ github.run_number }}
        path: |
          ./output/
          *.log
        retention-days: 30

    - name: Organize summaries for dashboard
      if: success()
      run: |
        WEEK_DATE=$(date +%Y-%m-%d)
        TARGET_DIR="dashboard/public/summaries/$WEEK_DATE"

        echo "ðŸ“ Organizing summaries for week: $WEEK_DATE"
        mkdir -p "$TARGET_DIR"

        # Copy generated summaries to dashboard folder
        if [ -d "./output/summaries" ] && [ "$(ls -A ./output/summaries/*.md 2>/dev/null)" ]; then
          cp ./output/summaries/*.md "$TARGET_DIR/" || true
          echo "âœ… Copied summaries to $TARGET_DIR"

          # Generate metadata.json
          python3 scripts/generate_metadata.py "$TARGET_DIR"
        else
          echo "âš ï¸ No summaries found to organize"
        fi

    - name: Commit summaries to repository
      if: success()
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add dashboard/public/summaries/

        if git diff --staged --quiet; then
          echo "No new summaries to commit"
        else
          WEEK_DATE=$(date +%Y-%m-%d)
          git commit -m "Add podcast summaries for week of $WEEK_DATE"
          git push
          echo "âœ… Pushed summaries to repository"
        fi

    - name: Display summary
      if: always()
      run: |
        echo "## ðŸ“Š Podcast Automation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -d "./output/podcast_notes" ]; then
          EPISODE_COUNT=$(ls -1 ./output/podcast_notes/*.md 2>/dev/null | wc -l)
          echo "- **Episodes processed:** $EPISODE_COUNT" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -d "./output/summaries" ]; then
          SUMMARY_COUNT=$(ls -1 ./output/summaries/*.md 2>/dev/null | wc -l)
          echo "- **Summaries generated:** $SUMMARY_COUNT" >> $GITHUB_STEP_SUMMARY
        fi

        WEEK_DATE=$(date +%Y-%m-%d)
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Week:** $WEEK_DATE" >> $GITHUB_STEP_SUMMARY
        echo "- **Dashboard:** Will be deployed to Vercel automatically" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Workflow completed successfully!" >> $GITHUB_STEP_SUMMARY
